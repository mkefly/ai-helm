{{- if and .Values.istio.enabled .Values.istio.host .Values.istio.gateway.name }}
{{- $root := . -}}
{{- $base := .Values.istio.basePath | default "/" | trimSuffix "/" }}

{{- /* First pass: detect if at least one route will be rendered */}}
{{- $hasRoutes := dict "any" false }}
{{- range $idx, $raw := .Values.apps }}
  {{- $appYaml := include "ai-workloads.applyKindDefaults" (dict "root" $root "obj" $raw) }}
  {{- $app := fromYaml $appYaml }}
  {{- $svc := $app.service | default dict }}
  {{- if and $svc.enabled (not $svc.skipVirtualService) $svc.ports }}
    {{- $_ := set $hasRoutes "any" true }}
  {{- end }}
{{- end }}

{{- if $hasRoutes.any }}
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: {{ include "ai-workloads.fullname" . }}-vs
  labels:
    app.kubernetes.io/name: {{ .Chart.Name }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: "ai-workloads-helm"
spec:
  hosts:
    - {{ .Values.istio.host | quote }}
  gateways:
    - {{ printf "%s/%s" .Values.istio.gateway.namespace .Values.istio.gateway.name | quote }}
  http:
{{- range $idx, $raw := .Values.apps }}
  {{- $appYaml := include "ai-workloads.applyKindDefaults" (dict "root" $root "obj" $raw) }}
  {{- $app := fromYaml $appYaml }}
  {{- $svc := $app.service | default dict }}

  {{- if and $svc.enabled (not $svc.skipVirtualService) $svc.ports }}

    {{- $segment := $app.name }}
    {{- if $svc.pathPrefix }}
      {{- $segment = trimPrefix "/" $svc.pathPrefix }}
    {{- end }}
    {{- $prefix := printf "%s/%s" $base $segment | replace "//" "/" }}
    {{- $httpPort := (include "ai-workloads.serviceHttpPort" (dict "service" $svc) | trim | default "") }}

    {{- if $httpPort }}
    - name: {{ $app.name }}
      match:
        - uri:
            regex: {{ printf "^%s(/(.*))?$" $prefix | quote }}
      rewrite:
        uri: "/$2"
      route:
        - destination:
            host: {{ include "ai-workloads.appName" (dict "root" $root "app" $app) }}
            port:
              number: {{ $httpPort | int }}
    {{- if $root.Values.istio.timeout }}
      timeout: {{ $root.Values.istio.timeout }}
    {{- end }}
    {{- if $root.Values.istio.retries }}
      retries:
{{ toYaml $root.Values.istio.retries | indent 8 }}
    {{- end }}
    {{- end }}

  {{- end }}
{{- end }}
{{- end }}
{{- end }}
