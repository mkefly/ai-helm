{{- /*
Generate HPAs for apps, using:
  - app.hpa.enabled: bool – whether to create an HPA
  - app.hpa.profile: string – selects min/max from .Values.hpa.profiles
  - app.hpa.metrics: [] – optional override; otherwise .Values.hpa.metrics is used
*/ -}}
{{- $root := . -}}
{{- $apps := .Values.apps | default (list) -}}

{{- range $idx, $raw := $apps }}
  {{- $appYaml := include "ai-workloads.applyKindDefaults" (dict "root" $root "obj" $raw) }}
  {{- $app := fromYaml $appYaml }}
  {{- $hpa := $app.hpa | default dict }}

  {{- if $hpa.enabled }}
    {{- $profileName := $hpa.profile | default $root.Values.hpa.defaultProfile }}
    {{- $profile := index ($root.Values.hpa.profiles | default dict) $profileName | default dict }}

    {{- $minReplicas := coalesce $hpa.minReplicas $profile.minReplicas 1 }}
    {{- $maxReplicas := coalesce $hpa.maxReplicas $profile.maxReplicas 5 }}

    {{- $metrics := $hpa.metrics | default $root.Values.hpa.metrics | default (list) }}
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ include "ai-workloads.appName" (dict "root" $root "app" $app) }}-hpa
  labels:
    app.kubernetes.io/name: {{ $app.name }}
    app.kubernetes.io/instance: {{ $root.Release.Name }}
    app.kubernetes.io/component: {{ $app.kind | default "app" }}
    app.kubernetes.io/managed-by: "ai-workloads-helm"
    app.kubernetes.io/part-of: {{ $root.Chart.Name }}
    ai-workloads/hpa-profile: {{ $profileName | quote }}
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ include "ai-workloads.appName" (dict "root" $root "app" $app) }}
  minReplicas: {{ $minReplicas }}
  maxReplicas: {{ $maxReplicas }}
  metrics:
{{ toYaml $metrics | indent 4 }}
  {{- end }}
{{- end }}
