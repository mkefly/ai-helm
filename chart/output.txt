
================================================================================
FILE: Chart.yaml
================================================================================

apiVersion: v2
name: ai-workloads
description: Unified Helm chart for AI services (Deployments) and batch tasks (Jobs/CronJobs) with shared infra profiles, generic settings and optional Istio + AAD integration.
type: application
version: 0.9.1
appVersion: "1.0.0"



================================================================================
FILE: values.schema.json
================================================================================

{
  "$schema": "https://json-schema.org/draft-07/schema#",
  "title": "ai-workloads values",
  "type": "object",
  "properties": {
    "global": {
      "type": "object",
      "properties": {
        "imagePullSecrets": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "name": {
                "type": "string"
              }
            },
            "required": [
              "name"
            ]
          },
          "description": "Image pull secrets applied to all workloads."
        }
      }
    },
    "infraProfiles": {
      "type": "object",
      "description": "Named infra profiles for CPU/GPU resources and placement.",
      "additionalProperties": {
        "type": "object",
        "properties": {
          "resources": {
            "type": "object"
          },
          "nodeSelector": {
            "type": "object"
          },
          "tolerations": {
            "type": "array"
          },
          "affinity": {
            "type": "object"
          }
        }
      }
    },
    "serviceAccount": {
      "type": "object",
      "properties": {
        "create": {
          "type": "boolean",
          "default": true
        },
        "name": {
          "type": "string"
        },
        "annotations": {
          "type": "object"
        }
      }
    },
    "metadata": {
      "type": "object",
      "properties": {
        "labels": {
          "type": "object"
        }
      }
    },
    "podSecurityContext": {
      "type": "object"
    },
    "containerSecurityContext": {
      "type": "object"
    },
    "istio": {
      "type": "object",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": false
        },
        "host": {
          "type": "string"
        },
        "gateway": {
          "type": "object",
          "properties": {
            "name": {
              "type": "string"
            },
            "namespace": {
              "type": "string",
              "default": "istio-system"
            }
          }
        },
        "basePath": {
          "type": "string",
          "default": "/"
        },
        "timeout": {
          "type": "string"
        },
        "retries": {
          "type": "object",
          "properties": {
            "attempts": {
              "type": "integer"
            },
            "perTryTimeout": {
              "type": "string"
            },
            "retryOn": {
              "type": "string"
            }
          }
        }
      }
    },
    "aad": {
      "type": "object",
      "properties": {
        "tenantId": {
          "type": "string"
        },
        "apiAudience": {
          "type": "string"
        },
        "audiences": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "requestAuth": {
      "type": "object",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": false
        }
      }
    },
    "aadPolicies": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "name": {
            "type": "string"
          },
          "namespace": {
            "type": "string"
          },
          "namespaceWide": {
            "type": "boolean"
          },
          "allowSameNamespaceInternal": {
            "type": "boolean"
          },
          "allowedPaths": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "allowedGroups": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "allowedClientIds": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "selector": {
            "type": "object"
          }
        }
      }
    },
    "apps": {
      "type": "array",
      "description": "Long-lived services (Deployments).",
      "items": {
        "type": "object",
        "required": [
          "name",
          "image"
        ],
        "properties": {
          "name": {
            "type": "string"
          },
          "kind": {
            "type": "string"
          },
          "infraProfile": {
            "type": "string"
          },
          "replicas": {
            "type": "integer"
          },
          "priorityClassName": {
            "type": "string"
          },
          "image": {
            "type": "object",
            "required": [
              "repository",
              "tag"
            ],
            "properties": {
              "repository": {
                "type": "string"
              },
              "tag": {
                "type": "string"
              },
              "pullPolicy": {
                "type": "string"
              }
            }
          },
          "service": {
            "type": "object",
            "properties": {
              "enabled": {
                "type": "boolean"
              },
              "type": {
                "type": "string"
              },
              "skipVirtualService": {
                "type": "boolean"
              },
              "pathPrefix": {
                "type": "string"
              },
              "ports": {
                "type": "array",
                "items": {
                  "type": "object",
                  "required": [
                    "port"
                  ],
                  "properties": {
                    "name": {
                      "type": "string"
                    },
                    "port": {
                      "type": "integer"
                    },
                    "targetPort": {
                      "type": [
                        "integer",
                        "string"
                      ]
                    },
                    "protocol": {
                      "type": "string"
                    },
                    "appProtocol": {
                      "type": "string"
                    },
                    "path": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "settings": {
            "type": [
              "string",
              "null"
            ],
            "description": "Inline JSON settings content."
          },
          "settingsConfigMapName": {
            "type": "string",
            "description": "If set, reuse this ConfigMap name instead of creating <app>-settings."
          },
          "settingsMountPath": {
            "type": "string",
            "description": "Mount path for settings volume, default /etc/settings."
          },
          "initContainers": {
            "type": "array"
          },
          "sidecarContainers": {
            "type": "array"
          },
          "command": {
            "type": "array"
          },
          "args": {
            "type": "array"
          },
          "env": {
            "type": "array",
            "items": {
              "type": "object",
              "required": [
                "name"
              ],
              "properties": {
                "name": {
                  "type": "string"
                },
                "value": {
                  "type": "string"
                },
                "valueFrom": {
                  "type": "object"
                }
              },
              "oneOf": [
                {
                  "required": [
                    "value"
                  ]
                },
                {
                  "required": [
                    "valueFrom"
                  ]
                }
              ]
            }
          },
          "envFrom": {
            "type": "array"
          },
          "livenessProbe": {
            "type": "object"
          },
          "readinessProbe": {
            "type": "object"
          },
          "startupProbe": {
            "type": "object"
          },
          "labels": {
            "type": "object"
          },
          "annotations": {
            "type": "object"
          },
          "podAnnotations": {
            "type": "object"
          },
          "resources": {
            "type": "object"
          },
          "volumeMounts": {
            "type": "array"
          },
          "volumes": {
            "type": "array"
          },
          "hpa": {
            "type": "object",
            "properties": {
              "enabled": {
                "type": "boolean"
              },
              "minReplicas": {
                "type": "integer"
              },
              "maxReplicas": {
                "type": "integer"
              },
              "metrics": {
                "type": "array",
                "description": "Autoscaling metrics list for autoscaling/v2. Must not be empty when hpa.enabled=true."
              }
            }
          }
        }
      }
    },
    "batchTasks": {
      "type": "array",
      "description": "Batch workloads (Jobs and CronJobs).",
      "items": {
        "type": "object",
        "required": [
          "name",
          "image"
        ],
        "properties": {
          "name": {
            "type": "string"
          },
          "kind": {
            "type": "string"
          },
          "infraProfile": {
            "type": "string"
          },
          "priorityClassName": {
            "type": "string"
          },
          "image": {
            "type": "object",
            "required": [
              "repository",
              "tag"
            ],
            "properties": {
              "repository": {
                "type": "string"
              },
              "tag": {
                "type": "string"
              },
              "pullPolicy": {
                "type": "string"
              }
            }
          },
          "settings": {
            "type": [
              "string",
              "null"
            ],
            "description": "Inline JSON settings content."
          },
          "settingsConfigMapName": {
            "type": "string",
            "description": "If set, reuse this ConfigMap name instead of creating <task>-settings."
          },
          "settingsMountPath": {
            "type": "string",
            "description": "Mount path for settings volume, default /etc/settings."
          },
          "initContainers": {
            "type": "array"
          },
          "sidecarContainers": {
            "type": "array"
          },
          "command": {
            "type": "array"
          },
          "args": {
            "type": "array"
          },
          "env": {
            "type": "array",
            "items": {
              "type": "object",
              "required": [
                "name"
              ],
              "properties": {
                "name": {
                  "type": "string"
                },
                "value": {
                  "type": "string"
                },
                "valueFrom": {
                  "type": "object"
                }
              },
              "oneOf": [
                {
                  "required": [
                    "value"
                  ]
                },
                {
                  "required": [
                    "valueFrom"
                  ]
                }
              ]
            }
          },
          "envFrom": {
            "type": "array"
          },
          "livenessProbe": {
            "type": "object"
          },
          "readinessProbe": {
            "type": "object"
          },
          "startupProbe": {
            "type": "object"
          },
          "labels": {
            "type": "object"
          },
          "annotations": {
            "type": "object"
          },
          "podAnnotations": {
            "type": "object"
          },
          "resources": {
            "type": "object"
          },
          "volumeMounts": {
            "type": "array"
          },
          "volumes": {
            "type": "array"
          },
          "parallelism": {
            "type": "integer"
          },
          "completions": {
            "type": "integer"
          },
          "backoffLimit": {
            "type": "integer"
          },
          "successfulJobsHistoryLimit": {
            "type": "integer"
          },
          "failedJobsHistoryLimit": {
            "type": "integer"
          },
          "concurrencyPolicy": {
            "type": "string"
          },
          "activeDeadlineSeconds": {
            "type": "integer"
          },
          "schedule": {
            "type": "string"
          }
        }
      }
    }
  }
}


================================================================================
FILE: values.yaml
================================================================================

# Default values for ai-workloads.
#
# IMPORTANT:
#   By default this chart deploys NO workloads.
#   Both `apps` and `batchTasks` are empty.
#   Product charts or env overlays should define concrete workloads.

# -------------------------------------------------------------------
# Global config
# -------------------------------------------------------------------
global:
  # Image pull secrets applied to all workloads.
  imagePullSecrets: []
  # - name: my-registry-secret

# -------------------------------------------------------------------
# ServiceAccount
# -------------------------------------------------------------------
# ServiceAccount configuration for all workloads.
serviceAccount:
  # Create a ServiceAccount if true, otherwise use `default`.
  create: true
  # Name of the ServiceAccount to use. If empty, `<release>-ai-workloads-sa` is created.
  name: ""
  # Extra annotations on the ServiceAccount (for Workload Identity, etc.).
  annotations: {}

# -------------------------------------------------------------------
# Global metadata / labels
# -------------------------------------------------------------------
# Additional labels applied to all resources created by this chart.
metadata:
  labels: {}
  #   swc.id: "SWC-12345"
  #   owner.team: "team-foo"
  #   environment: "dev"

# -------------------------------------------------------------------
# Global security contexts (kept empty by default for simplicity)
# -------------------------------------------------------------------
# Pod-level security context applied to all workloads (if set).
podSecurityContext: {}
# Container-level security context applied to all containers (if set).
containerSecurityContext: {}

# -------------------------------------------------------------------
# Central infra profiles – single source of truth.
# Typically owned by the platform / infra team.
# -------------------------------------------------------------------
# Resource profiles (CPU/GPU, node placement) referenced by `infraProfile`.
infraProfiles:
  default:
    resources:
      requests:
        cpu: "200m"
        memory: "256Mi"
      limits:
        cpu: "1"
        memory: "1Gi"
    nodeSelector: {}
    tolerations: []
    affinity: {}

  cpu-small:
    resources:
      requests:
        cpu: "100m"
        memory: "256Mi"
      limits:
        cpu: "500m"
        memory: "512Mi"
    nodeSelector: {}
    tolerations: []
    affinity: {}

  cpu-medium:
    resources:
      requests:
        cpu: "500m"
        memory: "1Gi"
      limits:
        cpu: "2"
        memory: "4Gi"
    nodeSelector: {}
    tolerations: []
    affinity: {}

  gpu-small:
    resources:
      requests:
        nvidia.com/gpu: 1
        cpu: "1"
        memory: "8Gi"
      limits:
        nvidia.com/gpu: 1
        cpu: "4"
        memory: "16Gi"
    nodeSelector:
      workload: gpu
    tolerations:
      - key: "workload"
        operator: "Equal"
        value: "gpu"
        effect: "NoSchedule"
    affinity: {}

# -------------------------------------------------------------------
# Long-lived services (Deployments)
# -------------------------------------------------------------------
# List of long-lived services to deploy (Deployments).
apps: []
  # Example structures are documented in product-specific charts or overlays.

# -------------------------------------------------------------------
# Batch workloads (Jobs / CronJobs)
# -------------------------------------------------------------------
# List of batch workloads to deploy (Jobs / CronJobs).
batchTasks: []
  # Example structures are documented in product-specific charts or overlays.

# -------------------------------------------------------------------
# Layer 2: Istio VirtualService (single external host, many app paths)
# -------------------------------------------------------------------
istio:
  enabled: false
  host: ""
  gateway:
    name: ""
    namespace: "istio-system"
  basePath: "/"
  timeout: ""
  retries: {}
  #   attempts: 3
  #   perTryTimeout: 10s
  #   retryOn: "5xx,connect-failure,refused-stream"

# -------------------------------------------------------------------
# Layer 3: AAD / Entra ID integration for Istio
# -------------------------------------------------------------------
aad:
  tenantId: ""
  apiAudience: ""
  audiences: []

requestAuth:
  enabled: false

# List of AuthorizationPolicy definitions for AAD-protected workloads.
aadPolicies: []
  # - name: ns-all
  #   namespace: ai
  #   namespaceWide: true
  #   # When namespaceWide=true, selector (if set) is ignored and no selector block is rendered.
  #   allowSameNamespaceInternal: true
  #   allowedPaths: []
  #   allowedGroups: []
  #   allowedClientIds: []
  #   selector: {}



================================================================================
FILE: templates/_helpers.aad.tpl
================================================================================

{{/* AAD helpers */}}
{{- define "aad-guard.fullname" -}}
{{- include "ai-workloads.fullname" . -}}
{{- end -}}

{{- define "aad-guard.apiAudience" -}}
{{- $aad := .Values.aad | default dict -}}
{{- $aud := $aad.apiAudience | default (index ($aad.audiences | default (list "")) 0) -}}
{{- $aud | default "" -}}
{{- end -}}

{{- define "aad-guard.requestauth.name" -}}
{{ printf "%s-aad-requestauth" (include "ai-workloads.fullname" .) }}
{{- end -}}

{{- define "aad-guard.issuer" -}}
{{- $aad := .Values.aad | default dict -}}
{{- if $aad.tenantId -}}
{{ printf "https://login.microsoftonline.com/%s/v2.0" $aad.tenantId }}
{{- end -}}
{{- end -}}

{{- define "aad-guard.jwksUri" -}}
{{- $aad := .Values.aad | default dict -}}
{{- if $aad.tenantId -}}
{{ printf "https://login.microsoftonline.com/%s/discovery/v2.0/keys" $aad.tenantId }}
{{- end -}}
{{- end -}}



================================================================================
FILE: templates/_helpers.pod.tpl
================================================================================

{{- define "ai-workloads.podSpec" -}}
{{- $root := .root -}}
{{- $obj := .obj -}}
{{- $profile := .profile -}}
{{- $restartPolicy := .restartPolicy -}}

{{- if and (or $obj.settings $obj.settingsConfigMapName) (not $obj.settingsMountPath) }}
  {{- $_ := set $obj "settingsMountPath" "/etc/settings" }}
{{- end }}

serviceAccountName: {{ include "ai-workloads.serviceAccountName" $root }}
restartPolicy: {{ $restartPolicy }}
{{- if $root.Values.global.imagePullSecrets }}
imagePullSecrets:
{{ toYaml $root.Values.global.imagePullSecrets | indent 2 }}
{{- end }}

{{- with $root.Values.podSecurityContext }}
{{- if . }}
securityContext:
{{ toYaml . | indent 2 }}
{{- end }}
{{- end }}

{{- with $profile.nodeSelector }}
nodeSelector:
{{ toYaml . | indent 2 }}
{{- end }}

{{- with $profile.tolerations }}
tolerations:
{{ toYaml . | indent 2 }}
{{- end }}

{{- with $profile.affinity }}
affinity:
{{ toYaml . | indent 2 }}
{{- end }}

{{- if $obj.priorityClassName }}
priorityClassName: {{ $obj.priorityClassName | quote }}
{{- end }}

{{- with $obj.initContainers }}
initContainers:
{{ toYaml . | indent 2 }}
{{- end }}

containers:
  - name: {{ $obj.name }}
    image: "{{ $obj.image.repository }}:{{ $obj.image.tag }}"
    imagePullPolicy: {{ $obj.image.pullPolicy | default "IfNotPresent" }}
{{- with $root.Values.containerSecurityContext }}
{{- if . }}
    securityContext:
{{ toYaml . | indent 4 }}
{{- end }}
{{- end }}
{{- if $obj.command }}
    command:
{{ toYaml $obj.command | indent 6 }}
{{- end }}
{{- if $obj.args }}
    args:
{{ toYaml $obj.args | indent 6 }}
{{- end }}
{{- if $obj.env }}
    env:
{{- range $e := $obj.env }}
      - name: {{ $e.name }}
{{- if hasKey $e "value" }}
        value: {{ tpl $e.value $root | quote }}
{{- else if hasKey $e "valueFrom" }}
        valueFrom:
{{ toYaml $e.valueFrom | indent 10 }}
{{- end }}
{{- end }}
{{- end }}
{{- if $obj.envFrom }}
    envFrom:
{{ toYaml $obj.envFrom | indent 6 }}
{{- end }}
{{- if $obj.livenessProbe }}
    livenessProbe:
{{ toYaml $obj.livenessProbe | indent 6 }}
{{- end }}
{{- if $obj.readinessProbe }}
    readinessProbe:
{{ toYaml $obj.readinessProbe | indent 6 }}
{{- end }}
{{- if $obj.startupProbe }}
    startupProbe:
{{ toYaml $obj.startupProbe | indent 6 }}
{{- end }}
{{- if $obj.resources }}
    resources:
{{ toYaml $obj.resources | indent 6 }}
{{- else if $profile.resources }}
    resources:
{{ toYaml $profile.resources | indent 6 }}
{{- end }}

{{- /* Decide if we need the settings volume + mount */}}
{{- $needSettingsVolume := or $obj.settings $obj.settingsConfigMapName }}
{{- $needSettingsMount := and $obj.settingsMountPath $needSettingsVolume }}

{{- if or $obj.volumeMounts $needSettingsMount }}
    volumeMounts:
{{- if $obj.volumeMounts }}
{{ toYaml $obj.volumeMounts | indent 6 }}
{{- end }}
{{- if $needSettingsMount }}
      - name: app-settings
        mountPath: {{ $obj.settingsMountPath | quote }}
{{- end }}
{{- end }}

{{- if $obj.sidecarContainers }}
{{ toYaml $obj.sidecarContainers | indent 2 }}
{{- end }}

{{- if or $obj.volumes $needSettingsVolume }}
volumes:
{{- if $obj.volumes }}
{{ toYaml $obj.volumes | indent 2 }}
{{- end }}
{{- if $needSettingsVolume }}
  - name: app-settings
    configMap:
      name: {{ default (printf "%s-settings" (include "ai-workloads.appName" (dict "root" $root "app" $obj))) $obj.settingsConfigMapName | quote }}
{{- end }}
{{- end }}
{{- end -}}



================================================================================
FILE: templates/_helpers.names.tpl
================================================================================

{{/* Chart fullname: <release>-<chart> */}}
{{- define "ai-workloads.fullname" -}}
{{- printf "%s-%s" .Release.Name .Chart.Name | trunc 63 | trimSuffix "-" -}}
{{- end -}}

{{/* Build resource name for an app/task: <fullname>-<name> */}}
{{- define "ai-workloads.appName" -}}
{{- $root := .root -}}
{{- $obj := .app -}}
{{- printf "%s-%s" (include "ai-workloads.fullname" $root) $obj.name | trunc 63 | trimSuffix "-" -}}
{{- end -}}

{{/* Effective serviceAccountName */}}
{{- define "ai-workloads.serviceAccountName" -}}
{{- $ := . -}}
{{- if $.Values.serviceAccount.create -}}
  {{- if $.Values.serviceAccount.name -}}
{{ $.Values.serviceAccount.name }}
  {{- else -}}
{{ printf "%s-sa" (include "ai-workloads.fullname" $) }}
  {{- end -}}
{{- else -}}
default
{{- end -}}
{{- end -}}



================================================================================
FILE: templates/deployment.yaml
================================================================================

{{- $root := . -}}
{{- range $idx, $raw := .Values.apps }}
{{- $appYaml := include "ai-workloads.applyKindDefaults" (dict "root" $root "obj" $raw) }}
{{- $app := fromYaml $appYaml }}

{{- $profileYaml := include "ai-workloads.infraProfile" (dict "Values" $root.Values "app" $app) }}
{{- $profile := fromYaml $profileYaml }}

apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "ai-workloads.appName" (dict "root" $root "app" $app) }}
  labels:
{{ include "ai-workloads.standardLabels" (dict "root" $root "name" $app.name "component" ($app.kind | default "app") "extraLabels" $app.labels) | indent 4 }}
{{- with $app.annotations }}
  annotations:
{{ toYaml . | indent 4 }}
{{- end }}
spec:
  replicas: {{ default 1 $app.replicas }}
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ $app.name }}
      app.kubernetes.io/instance: {{ $root.Release.Name }}
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ $app.name }}
        app.kubernetes.io/instance: {{ $root.Release.Name }}
        app.kubernetes.io/component: {{ $app.kind | default "app" }}
        app.kubernetes.io/part-of: {{ $root.Chart.Name }}
{{- with $app.labels }}
{{ toYaml . | indent 8 }}
{{- end }}
      annotations:
{{- if $app.podAnnotations }}
{{ toYaml $app.podAnnotations | indent 8 }}
{{- else }}
        {}
{{- end }}
    spec:
{{ include "ai-workloads.podSpec" (dict "root" $root "obj" $app "profile" $profile "restartPolicy" "Always") | indent 6 }}
---
{{- end }}



================================================================================
FILE: templates/configmap-settings.yaml
================================================================================

{{- $root := . -}}
{{- range $idx, $app := .Values.apps }}
{{ include "ai-workloads.settingsConfigMap" (dict "root" $root "obj" $app "component" ($app.kind | default "app")) }}
{{- end }}



================================================================================
FILE: templates/NOTES.txt
================================================================================

{{- $root := . -}}
{{- $release := .Release.Name -}}
{{- $ns := .Release.Namespace -}}
{{- $apps := .Values.apps | default (list) -}}
{{- $tasks := .Values.batchTasks | default (list) -}}
{{- $istio := .Values.istio | default dict -}}
{{- $aad := .Values.aad | default dict -}}
{{- $aadPolicies := .Values.aadPolicies | default (list) -}}

============================================================
ai-workloads: Installation & Usage
Release: {{ $release }}
Namespace: {{ $ns }}
Chart Version: {{ .Chart.Version }}
============================================================

------------------------------------------------------------
1. What was deployed?
------------------------------------------------------------

{{- if eq (len $apps) 0 }}
No services (apps[]) were deployed.
→ To deploy workloads, define at least one entry under values.apps[].
{{- else }}
Services (Deployments):

{{- range $a := $apps }}
  • {{ $a.name }}
    Deployment: {{ include "ai-workloads.appName" (dict "root" $root "app" $a) }}
    Kind:       {{ $a.kind | default "app" }}
    Replicas:   {{ default 1 $a.replicas }}
    Service:    {{- if or (eq ($a.kind | default "") "mlserver") (and $a.service $a.service.enabled) }} enabled {{- else }} disabled {{- end }}
    Infra:      {{ default "default" $a.infraProfile }}
{{- end }}
{{- end }}

{{- if gt (len $tasks) 0 }}

Batch workloads (Jobs / CronJobs):

{{- range $t := $tasks }}
  • {{ $t.name }}
    Resource:   {{ include "ai-workloads.appName" (dict "root" $root "app" $t) }}
    Kind:       {{- if $t.schedule }} CronJob ({{ $t.schedule }}) {{- else }} Job (one-shot) {{- end }}
    Image:      {{ $t.image.repository }}:{{ $t.image.tag }}
    Infra:      {{ default "default" $t.infraProfile }}
{{- end }}
{{- else }}

No batch tasks (batchTasks[]) were deployed.
→ To deploy Jobs/CronJobs, define at least one entry under values.batchTasks[].
{{- end }}

------------------------------------------------------------
2. Quick usage / verification
------------------------------------------------------------

List all workloads:
    kubectl get deploy,svc,job,cronjob -n {{ $ns }}

Inspect pods:
    kubectl get pods -n {{ $ns }}

Port-forward a service (example):
    kubectl port-forward deploy/<app-name> 8000:8000 -n {{ $ns }}

Check this release's resources:
    helm get manifest {{ $release }} -n {{ $ns }}

------------------------------------------------------------
3. Key values at a glance
------------------------------------------------------------

ServiceAccount:
  create:  {{ default true .Values.serviceAccount.create }}
  name:    {{ include "ai-workloads.serviceAccountName" . }}

Istio:
  enabled: {{ default false $istio.enabled }}
  host:    {{ $istio.host | default "<not-set>" }}
  gateway: {{ $istio.gateway.name | default "<not-set>" }} (ns={{ $istio.gateway.namespace | default "istio-system" }})
  basePath: {{ $istio.basePath | default "/" }}

AAD / Entra ID:
  tenantId:      {{ $aad.tenantId | default "<not-set>" }}
  apiAudience:   {{ $aad.apiAudience | default "<not-set>" }}
  audiences[]:   {{- if $aad.audiences }} {{ join ", " $aad.audiences }} {{- else }} <empty> {{- end }}
  requestAuth:   {{ ternary "enabled" "disabled" (and $aad.tenantId .Values.requestAuth.enabled) }}

------------------------------------------------------------
4. Istio / external URLs
------------------------------------------------------------

{{- if $istio.enabled }}
Ingress Mode: Enabled
Host:         {{ $istio.host | default "<missing host>" }}
Base Path:    {{ $istio.basePath | default "/" }}

{{- if and $istio.host (gt (len $apps) 0) }}
Exposed app routes:
{{- $base := $istio.basePath | default "/" | trimSuffix "/" }}
{{- range $a := $apps }}
  {{- if and $a.service $a.service.enabled $a.service.ports }}
    {{- $segment := "" -}}
    {{- if $a.service.pathPrefix }}
      {{- $segment = trimPrefix "/" $a.service.pathPrefix -}}
    {{- else -}}
      {{- $segment = $a.name -}}
    {{- end }}
    {{- $prefix := printf "%s/%s" $base $segment | replace "//" "/" -}}
  • {{ printf "https://%s%s" $istio.host $prefix }}
  {{- end }}
{{- end }}

{{- else }}
No apps with enabled Service found for Istio routing.
{{- end }}

{{ else }}
Istio ingress is DISABLED.
You can still port-forward services manually:
    kubectl port-forward deploy/<name> 8000:8000 -n {{ $ns }}
{{- end }}

------------------------------------------------------------
5. AAD Authentication & AuthorizationPolicies
------------------------------------------------------------

{{- if and $aad.tenantId .Values.requestAuth.enabled }}
Tenant: {{ $aad.tenantId }}

RequestAuthentication objects:
  - One per namespace that appears in aadPolicies[].namespace (or the release namespace)

{{- if eq (len $aadPolicies) 0 }}
No AuthorizationPolicy resources defined (aadPolicies[] is empty).
{{- else }}
AuthorizationPolicies:
{{- range $p := $aadPolicies }}
  • {{ $p.name }}
    Namespace:                    {{ $p.namespace | default $ns }}
    Namespace-wide:               {{ default false $p.namespaceWide }}
    Internal same-namespace OK:   {{ default false $p.allowSameNamespaceInternal }}
    Allowed paths:                {{- if $p.allowedPaths }} {{ join ", " $p.allowedPaths }} {{- else }} <any> {{- end }}
    Allowed groups:               {{- if $p.allowedGroups }} {{ join ", " $p.allowedGroups }} {{- else }} <none> {{- end }}
    Allowed clientIds (azp):      {{- if $p.allowedClientIds }} {{ join ", " $p.allowedClientIds }} {{- else }} <none> {{- end }}
{{- end }}
{{- end }}

To inspect:
    kubectl get requestauthentication.security.istio.io -A
    kubectl get authorizationpolicies.security.istio.io -A

{{- else }}
AAD authentication disabled or incomplete.
→ To enable:
    requestAuth.enabled=true
    aad.tenantId="<tenant-id>"
    aad.apiAudience="<api-audience-or-resource>"
{{- end }}

------------------------------------------------------------
6. Infra profiles referenced by this release
------------------------------------------------------------

{{- $profilesUsed := dict }}
{{- range $a := $apps }}
  {{- $pname := default "default" $a.infraProfile }}
  {{- $_ := set $profilesUsed $pname true }}
{{- end }}
{{- range $t := $tasks }}
  {{- $pname := default "default" $t.infraProfile }}
  {{- $_ := set $profilesUsed $pname true }}
{{- end }}

{{- if gt (len $profilesUsed) 0 }}
Profiles referenced by apps/batchTasks:
{{- range $name, $_ := $profilesUsed }}
  • {{ $name }}
{{- end }}
{{- else }}
No infra profiles referenced explicitly (workloads will use the "default" profile).
{{- end }}

------------------------------------------------------------
7. Volumes, settings & sidecars (best-effort)
------------------------------------------------------------

{{- $volSummary := dict "any" false }}

{{- range $a := $apps }}
  {{- if or $a.volumeMounts $a.volumes $a.settings $a.settingsConfigMapName $a.initContainers $a.sidecarContainers }}
    {{- $_ := set $volSummary "any" true }}
• App "{{ $a.name }}":
  {{- if or $a.settings $a.settingsConfigMapName }}
    - Settings: {{- if $a.settingsConfigMapName }} external ConfigMap "{{ $a.settingsConfigMapName }}" {{- else }} inline settings → ConfigMap "<release>-<chart>-{{ $a.name }}-settings" {{- end }}
  {{- end }}
  {{- if $a.volumeMounts }}
    - Extra volumeMounts defined
  {{- end }}
  {{- if $a.volumes }}
    - Extra volumes defined
  {{- end }}
  {{- if $a.initContainers }}
    - initContainers defined
  {{- end }}
  {{- if $a.sidecarContainers }}
    - sidecarContainers defined
  {{- end }}
  {{- end }}
{{- end }}

{{- range $t := $tasks }}
  {{- if or $t.volumeMounts $t.volumes $t.settings $t.settingsConfigMapName $t.initContainers $t.sidecarContainers }}
    {{- $_ := set $volSummary "any" true }}
• Batch "{{ $t.name }}":
  {{- if or $t.settings $t.settingsConfigMapName }}
    - Settings: {{- if $t.settingsConfigMapName }} external ConfigMap "{{ $t.settingsConfigMapName }}" {{- else }} inline settings → ConfigMap "<release>-<chart>-{{ $t.name }}-settings" {{- end }}
  {{- end }}
  {{- if $t.volumeMounts }}
    - Extra volumeMounts defined
  {{- end }}
  {{- if $t.volumes }}
    - Extra volumes defined
  {{- end }}
  {{- if $t.initContainers }}
    - initContainers defined
  {{- end }}
  {{- if $t.sidecarContainers }}
    - sidecarContainers defined
  {{- end }}
  {{- end }}
{{- end }}

{{- if not (index $volSummary "any") }}
No extra volumes, settings, initContainers or sidecars detected.
{{- end }}

------------------------------------------------------------
8. Warnings & possible misconfigurations
------------------------------------------------------------

{{- $warn := dict "any" false }}

{{- range $a := $apps }}
  {{- if and $a.service $a.service.enabled (or (not $a.service.ports) (eq (len $a.service.ports) 0)) }}
    {{- $_ := set $warn "any" true }}
• App "{{ $a.name }}": service.enabled=true but no service.ports defined.
  {{- end }}
{{- end }}

{{- range $a := $apps }}
  {{- if and $a.hpa $a.hpa.enabled (or (not $a.hpa.metrics) (eq (len $a.hpa.metrics) 0)) }}
    {{- $_ := set $warn "any" true }}
• App "{{ $a.name }}": hpa.enabled=true but no hpa.metrics defined.
  HPA (autoscaling/v2) requires at least one metric block; the chart will skip rendering the HPA.
  {{- end }}
{{- end }}

{{- if and $istio.enabled (or (not $istio.host) (not $istio.gateway.name)) }}
  {{- $_ := set $warn "any" true }}
• Istio: istio.enabled=true but host and/or gateway.name not set.
{{- end }}

{{- range $p := $aadPolicies }}
  {{- if and $p.namespaceWide $p.selector }}
    {{- $_ := set $warn "any" true }}
• AAD Policy "{{ $p.name }}": namespaceWide=true and selector set.
  Selector is ignored when namespaceWide is true; policy will apply to the whole namespace.
  {{- end }}
{{- end }}

{{- if not (index $warn "any") }}
No obvious misconfigurations detected based on current values.
{{- end }}

============================================================
End of NOTES.
============================================================



================================================================================
FILE: templates/_helpers.infra.tpl
================================================================================

{{- define "ai-workloads.infraProfile" -}}
{{- $values := .Values -}}
{{- $obj := .app -}}
{{- $profiles := $values.infraProfiles | default dict -}}
{{- $name := $obj.infraProfile | default "default" -}}
{{- index $profiles $name | default dict | toYaml -}}
{{- end -}}



================================================================================
FILE: templates/virtualservice.yaml
================================================================================

{{- if and .Values.istio.enabled .Values.istio.host .Values.istio.gateway.name }}
{{- $root := . -}}
{{- $base := .Values.istio.basePath | default "/" | trimSuffix "/" }}

{{- /* First pass: detect if at least one route will be rendered */}}
{{- $hasRoutes := dict "any" false }}
{{- range $idx, $app := .Values.apps }}
  {{- $kind := $app.kind | default "" }}
  {{- if and $app.service $app.service.enabled (not $app.service.skipVirtualService) $app.service.ports }}
    {{- $_ := set $hasRoutes "any" true }}
  {{- else if and (eq $kind "mlserver") (not $app.service) }}
    {{- $_ := set $hasRoutes "any" true }}
  {{- end }}
{{- end }}

{{- if $hasRoutes.any }}
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: {{ include "ai-workloads.fullname" . }}-vs
  labels:
    app.kubernetes.io/name: {{ .Chart.Name }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: "ai-workloads-helm"
spec:
  hosts:
    - {{ .Values.istio.host }}
  gateways:
    - {{ printf "%s/%s" .Values.istio.gateway.namespace .Values.istio.gateway.name }}
  http:
{{- range $idx, $app := .Values.apps }}
  {{- $kind := $app.kind | default "" }}

  {{- if and $app.service $app.service.enabled (not $app.service.skipVirtualService) $app.service.ports }}

    {{- $httpPort := index $app.service.ports 0 }}
    {{- range $i, $p := $app.service.ports }}
      {{- if eq $p.name "http" }}
        {{- $httpPort = $p }}
      {{- end }}
    {{- end }}

    {{- $segment := "" -}}
    {{- if $app.service.pathPrefix -}}
      {{- $segment = trimPrefix "/" $app.service.pathPrefix -}}
    {{- else -}}
      {{- $segment = $app.name -}}
    {{- end }}
    {{- $prefix := printf "%s/%s" $base $segment | replace "//" "/" -}}

    - name: {{ $app.name }}
      match:
        - uri:
            regex: {{ printf "^%s(/(.*))?$" $prefix | quote }}
      rewrite:
        uri: "/$2"
      route:
        - destination:
            host: {{ include "ai-workloads.appName" (dict "root" $root "app" $app) }}
            port:
              number: {{ $httpPort.port }}
    {{- if $root.Values.istio.timeout }}
      timeout: {{ $root.Values.istio.timeout }}
    {{- end }}
    {{- if $root.Values.istio.retries }}
      retries:
{{ toYaml $root.Values.istio.retries | indent 8 }}
    {{- end }}

  {{- else if and (eq $kind "mlserver") (not $app.service) }}

    {{- $segment := $app.name -}}
    {{- $prefix := printf "%s/%s" $base $segment | replace "//" "/" -}}

    - name: {{ $app.name }}
      match:
        - uri:
            regex: {{ printf "^%s(/(.*))?$" $prefix | quote }}
      rewrite:
        uri: "/$2"
      route:
        - destination:
            host: {{ include "ai-workloads.appName" (dict "root" $root "app" $app) }}
            port:
              number: 8000
    {{- if $root.Values.istio.timeout }}
      timeout: {{ $root.Values.istio.timeout }}
    {{- end }}
    {{- if $root.Values.istio.retries }}
      retries:
{{ toYaml $root.Values.istio.retries | indent 8 }}
    {{- end }}

  {{- end }}
{{- end }}
{{- end }}
{{- end }}



================================================================================
FILE: templates/_helpers.kinds.mlserver.tpl
================================================================================

{{/*
Kind-specific defaults for kind: mlserver.

Responsibilities:
  - Ensure there is a Service (enabled by default) on port 8000 if none defined
  - Derive MLSERVER_HTTP_PORT from the first service port
  - Provide sensible default liveness/readiness probes
  - Provide a default command/args to start mlserver with /etc/settings/settings.json
*/}}
{{- define "ai-workloads.applyKindDefaults.mlserver" -}}
{{- $root := .root -}}
{{- $in := .obj -}}

{{- /* Start with a shallow copy so we can mutate safely */}}
{{- $app := deepCopy $in -}}

{{- if not $app.service }}
  {{- /* Ensure service exists */}}
  {{- $_ := set $app "service" (dict) }}
{{- end }}

{{- /* Convenience local */}}
{{- $svc := $app.service -}}

{{- /* Enable service by default if not explicitly set */}}
{{- if not (hasKey $svc "enabled") }}
  {{- $_ := set $svc "enabled" true }}
{{- end }}

{{- /* Default Service ports: HTTP on 8000 */}}
{{- if not $svc.ports }}
  {{- $defaultPorts := list (dict
        "name"       "http"
        "port"       8000
        "targetPort" 8000
        "protocol"   "TCP"
      ) }}
  {{- $_ := set $svc "ports" $defaultPorts }}
{{- end }}

{{- if not $app.env }}
  {{- $_ := set $app "env" (list) }}
{{- end }}

{{- $ports := $svc.ports | default (list) }}

{{- if gt (len $ports) 0 }}
  {{- /* Use the first declared port as the HTTP port */}}
  {{- $httpPort := index $ports 0 }}
  {{- $portVal := $httpPort.port | default 8000 }}

  {{- /* Append MLSERVER_HTTP_PORT */}}
  {{- $_ := set $app "env" (append $app.env (dict
        "name"  "MLSERVER_HTTP_PORT"
        "value" (printf "%v" $portVal)
      )) }}
{{- end }}

{{- if not $app.livenessProbe }}
  {{- $_ := set $app "livenessProbe" (dict
        "httpGet"             (dict "path" "/v2/health/live"  "port" 8000)
        "initialDelaySeconds" 10
        "periodSeconds"       15
        "timeoutSeconds"      2
      ) }}
{{- end }}

{{- if not $app.readinessProbe }}
  {{- $_ := set $app "readinessProbe" (dict
        "httpGet"             (dict "path" "/v2/health/ready" "port" 8000)
        "initialDelaySeconds" 5
        "periodSeconds"       10
        "timeoutSeconds"      2
      ) }}
{{- end }}

{{- if and (not $app.command) (not $app.args) }}
  {{- $_ := set $app "command" (list "mlserver") }}
  {{- $_ := set $app "args" (list
        "start"
        "--settings"
        "/etc/settings/settings.json"
      ) }}
{{- end }}

{{- /* Default settingsMountPath for mlserver if we have settings but no mount path */}}
{{- if and $app.settings (not $app.settingsMountPath) }}
  {{- $_ := set $app "settingsMountPath" "/etc/settings" }}
{{- end }}

{{ toYaml $app }}
{{- end -}}



================================================================================
FILE: templates/batch-task.yaml
================================================================================

{{- $root := . -}}
{{- range $idx, $task := .Values.batchTasks }}
{{- $profileYaml := include "ai-workloads.infraProfile" (dict "Values" $root.Values "app" $task) }}
{{- $profile := fromYaml $profileYaml }}
{{- if $task.schedule }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "ai-workloads.appName" (dict "root" $root "app" $task) }}
  labels:
{{ include "ai-workloads.standardLabels" (dict "root" $root "name" $task.name "component" "batch" "extraLabels" $task.labels) | indent 4 }}
spec:
  schedule: {{ quote $task.schedule }}
  concurrencyPolicy: {{ default "Forbid" $task.concurrencyPolicy }}
  successfulJobsHistoryLimit: {{ default 1 $task.successfulJobsHistoryLimit }}
  failedJobsHistoryLimit: {{ default 1 $task.failedJobsHistoryLimit }}
  jobTemplate:
    spec:
      parallelism: {{ default 1 $task.parallelism }}
      completions: {{ default 1 $task.completions }}
      backoffLimit: {{ default 0 $task.backoffLimit }}
{{- if $task.activeDeadlineSeconds }}
      activeDeadlineSeconds: {{ $task.activeDeadlineSeconds }}
{{- end }}
      template:
        metadata:
          labels:
            app.kubernetes.io/name: {{ $task.name }}
            app.kubernetes.io/instance: {{ $root.Release.Name }}
            app.kubernetes.io/component: "batch"
            app.kubernetes.io/part-of: {{ $root.Chart.Name }}
{{- with $task.labels }}
{{ toYaml . | indent 12 }}
{{- end }}
          annotations:
{{- if $task.podAnnotations }}
{{ toYaml $task.podAnnotations | indent 12 }}
{{- else }}
            {}
{{- end }}
        spec:
{{ include "ai-workloads.podSpec" (dict "root" $root "obj" $task "profile" $profile "restartPolicy" "Never") | indent 10 }}
---
{{- else }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "ai-workloads.appName" (dict "root" $root "app" $task) }}
  labels:
{{ include "ai-workloads.standardLabels" (dict "root" $root "name" $task.name "component" "batch" "extraLabels" $task.labels) | indent 4 }}
spec:
  parallelism: {{ default 1 $task.parallelism }}
  completions: {{ default 1 $task.completions }}
  backoffLimit: {{ default 0 $task.backoffLimit }}
{{- if $task.activeDeadlineSeconds }}
  activeDeadlineSeconds: {{ $task.activeDeadlineSeconds }}
{{- end }}
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ $task.name }}
        app.kubernetes.io/instance: {{ $root.Release.Name }}
        app.kubernetes.io/component: "batch"
        app.kubernetes.io/part-of: {{ $root.Chart.Name }}
{{- with $task.labels }}
{{ toYaml . | indent 8 }}
{{- end }}
      annotations:
{{- if $task.podAnnotations }}
{{ toYaml $task.podAnnotations | indent 8 }}
{{- else }}
        {}
{{- end }}
    spec:
{{ include "ai-workloads.podSpec" (dict "root" $root "obj" $task "profile" $profile "restartPolicy" "Never") | indent 6 }}
---
{{- end }}
{{- end }}



================================================================================
FILE: templates/_helpers.labels.tpl
================================================================================

{{- define "ai-workloads.standardLabels" -}}
app.kubernetes.io/name: {{ .name }}
app.kubernetes.io/instance: {{ .root.Release.Name }}
app.kubernetes.io/component: {{ .component | default "app" }}
app.kubernetes.io/managed-by: "ai-workloads-helm"
app.kubernetes.io/part-of: {{ .root.Chart.Name }}
{{- with .root.Values.metadata.labels }}
{{ toYaml . | nindent 0 }}
{{- end }}
{{- with .extraLabels }}
{{ toYaml . | nindent 0 }}
{{- end }}
{{- end -}}



================================================================================
FILE: templates/service.yaml
================================================================================

{{- $root := . -}}
{{- range $idx, $app := .Values.apps }}
{{- $kind := $app.kind | default "" }}

{{- if eq $kind "mlserver" }}

  {{- /* Simple mlserver: no service defined -> default ClusterIP:8000 */}}
  {{- if not $app.service }}
    {{- $ports := list (dict "name" "http" "port" 8000 "targetPort" 8000 "protocol" "TCP") }}
    {{- $ctx := dict "root" $root "app" $app "type" "ClusterIP" "ports" $ports }}
{{ include "ai-workloads.serviceTemplate" $ctx }}
---
  {{- else if and $app.service.enabled $app.service.ports }}
    {{- $ctx := dict "root" $root "app" $app "type" (default "ClusterIP" $app.service.type) "ports" $app.service.ports }}
{{ include "ai-workloads.serviceTemplate" $ctx }}
---
  {{- end }}

{{- else }}

  {{- if and $app.service $app.service.enabled $app.service.ports }}
    {{- $ctx := dict "root" $root "app" $app "type" (default "ClusterIP" $app.service.type) "ports" $app.service.ports }}
{{ include "ai-workloads.serviceTemplate" $ctx }}
---
  {{- end }}

{{- end }}
{{- end }}



================================================================================
FILE: templates/hpa.yaml
================================================================================

{{- $root := . -}}
{{- range $idx, $app := .Values.apps }}
{{- if and $app.hpa $app.hpa.enabled $app.hpa.metrics (gt (len $app.hpa.metrics) 0) }}
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ include "ai-workloads.appName" (dict "root" $root "app" $app) }}-hpa
  labels:
{{ include "ai-workloads.standardLabels" (dict "root" $root "name" $app.name "component" ($app.kind | default "app") "extraLabels" $app.labels) | indent 4 }}
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ include "ai-workloads.appName" (dict "root" $root "app" $app) }}
  minReplicas: {{ $app.hpa.minReplicas | default 1 }}
  maxReplicas: {{ $app.hpa.maxReplicas | default 5 }}
  metrics:
{{ toYaml $app.hpa.metrics | indent 4 }}
---
{{- end }}
{{- end }}



================================================================================
FILE: templates/aad-authzpolicy.yaml
================================================================================

{{- $root := . -}}
{{- $globalAud := include "aad-guard.apiAudience" . -}}

{{- if and .Values.aad.tenantId .Values.aadPolicies }}

{{- range $t := .Values.aadPolicies }}

  {{- $ns := default $root.Release.Namespace $t.namespace }}
  {{- $groups := $t.allowedGroups | default (list) }}
  {{- $clients := $t.allowedClientIds | default (list) }}
  {{- $allowSameNs := $t.allowSameNamespaceInternal | default false }}
  {{- $paths := $t.allowedPaths | default (list) }}
  {{- $namespaceWide := $t.namespaceWide | default false }}

apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: {{ printf "%s-%s-aad" (include "aad-guard.fullname" $root) $t.name | trunc 63 | trimSuffix "-" }}
  namespace: {{ $ns }}
spec:
  {{- if not $namespaceWide }}
  selector:
    {{- if and $t.selector (gt (len $t.selector) 0) }}
{{ toYaml $t.selector | indent 4 }}
    {{- else }}
      matchLabels:
        app.kubernetes.io/name: {{ $t.name }}
    {{- end }}
  {{- end }}

  action: ALLOW
  rules:
    {{- if $allowSameNs }}
    - from:
        - source:
            namespaces: [{{ $ns | quote }}]
      {{- if $paths }}
      to:
        - operation:
            paths:
              {{- range $paths }}
              - {{ . | quote }}
              {{- end }}
      {{- end }}
    {{- end }}

    - from:
        - source:
            requestPrincipals: ["*"]
      {{- if $paths }}
      to:
        - operation:
            paths:
              {{- range $paths }}
              - {{ . | quote }}
              {{- end }}
      {{- end }}
      when:
        {{- if $globalAud }}
        - key: request.auth.claims[aud]
          values:
            - {{ $globalAud | quote }}
        {{- end }}

        {{- if $groups }}
        - key: request.auth.claims[groups]
          values:
            {{- range $groups }}
            - {{ . | quote }}
            {{- end }}
        {{- end }}

        {{- if $clients }}
        - key: request.auth.claims[azp]
          values:
            {{- range $clients }}
            - {{ . | quote }}
            {{- end }}
        {{- end }}
---
{{- end }}
{{- end }}



================================================================================
FILE: templates/serviceaccount.yaml
================================================================================

{{- if .Values.serviceAccount.create }}
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "ai-workloads.serviceAccountName" . }}
{{- if .Values.serviceAccount.annotations }}
  annotations:
{{ toYaml .Values.serviceAccount.annotations | indent 4 }}
{{- end }}
---
{{- end }}



================================================================================
FILE: templates/_helpers.settings-configmap.tpl
================================================================================

{{- define "ai-workloads.settingsConfigMap" -}}
{{- $root := .root -}}
{{- $obj := .obj -}}
{{- $component := .component -}}
{{- if and $obj.settings (not $obj.settingsConfigMapName) }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "ai-workloads.appName" (dict "root" $root "app" $obj) }}-settings
  labels:
{{ include "ai-workloads.standardLabels" (dict "root" $root "name" $obj.name "component" $component "extraLabels" $obj.labels) | indent 4 }}
data:
  settings.json: |
{{ $obj.settings | indent 4 }}
---
{{- end }}
{{- end -}}



================================================================================
FILE: templates/_helpers.service.tpl
================================================================================

{{/* DRY Service renderer for any app */}}
{{- define "ai-workloads.serviceTemplate" -}}
{{- $root := .root -}}
{{- $app := .app -}}
apiVersion: v1
kind: Service
metadata:
  name: {{ include "ai-workloads.appName" (dict "root" $root "app" $app) }}
  labels:
{{ include "ai-workloads.standardLabels" (dict "root" $root "name" $app.name "component" ($app.kind | default "app") "extraLabels" $app.labels) | indent 4 }}
spec:
  type: {{ .type }}
  selector:
    app.kubernetes.io/name: {{ $app.name }}
    app.kubernetes.io/instance: {{ $root.Release.Name }}
  ports:
{{- range $i, $p := .ports }}
    - name: {{ default (printf "port-%d" $i) $p.name }}
      port: {{ $p.port }}
      targetPort: {{ default $p.targetPort $p.port }}
      protocol: {{ default "TCP" $p.protocol }}
{{- if $p.appProtocol }}
      appProtocol: {{ $p.appProtocol }}
{{- end }}
{{- end }}
{{- end -}}



================================================================================
FILE: templates/batch-configmap-settings.yaml
================================================================================

{{- $root := . -}}
{{- range $idx, $task := .Values.batchTasks }}
{{ include "ai-workloads.settingsConfigMap" (dict "root" $root "obj" $task "component" "batch") }}
{{- end }}



================================================================================
FILE: templates/_helpers.kinds.tpl
================================================================================

{{/*
Apply kind-specific defaults (mlserver, etc.) to an app definition,
so that renderers can stay generic and not care about .kind.

Usage:
  {{- $appYaml := include "ai-workloads.applyKindDefaults" (dict "root" . "obj" $raw) -}}
  {{- $app := fromYaml $appYaml -}}
*/}}
{{- define "ai-workloads.applyKindDefaults" -}}
{{- $root := .root -}}
{{- $in := .obj -}}
{{- $kind := $in.kind | default "" -}}

{{- if eq $kind "mlserver" -}}
  {{- include "ai-workloads.applyKindDefaults.mlserver" (dict "root" $root "obj" $in) -}}
{{- else -}}
  {{ toYaml $in }}
{{- end -}}
{{- end -}}



================================================================================
FILE: templates/aad-requestauth.yaml
================================================================================

{{- $root := . -}}
{{- $globalAud := include "aad-guard.apiAudience" . -}}

{{- if and $root.Values.aad.tenantId $root.Values.requestAuth.enabled }}

{{- $nsSet := dict }}
{{- $_ := set $nsSet $root.Release.Namespace true }}

{{- range $root.Values.aadPolicies }}
  {{- $ns := default $root.Release.Namespace .namespace }}
  {{- $_ := set $nsSet $ns true }}
{{- end }}

{{- range $ns, $_ := $nsSet }}
apiVersion: security.istio.io/v1
kind: RequestAuthentication
metadata:
  name: {{ printf "%s-%s" (include "aad-guard.requestauth.name" $root) $ns | trunc 63 | trimSuffix "-" }}
  namespace: {{ $ns }}
spec:
  jwtRules:
    - issuer: {{ include "aad-guard.issuer" $root | quote }}
      jwksUri: {{ include "aad-guard.jwksUri" $root | quote }}
      {{- if $globalAud }}
      audiences:
        - {{ $globalAud | quote }}
      {{- end }}
---
{{- end }}
{{- end }}


